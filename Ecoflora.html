<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Interaktif Flora & Fauna Indonesia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #81c784;
            --text-dark: #1b5e20;
            --text-light: #f1f8e9;
            --background-light: #e8f5e9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-light);
            color: #333;
        }
        
        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        nav a:hover, nav a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section-title {
            color: var(--text-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
        }
        
        /* Map Controls */
        .map-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Search input */
        .search-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input input[type="search"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            width: 100%;
            background: white;
        }

        .search-input button {
            padding: 10px 12px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-dark);
        }
        
        .control-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        
        /* Map Container */
        .map-wrapper {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
        }
        
        /* Custom Marker Popup */
        .custom-popup {
            min-width: 250px;
        }
        
        .popup-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .popup-scientific {
            font-style: italic;
            color: #666;
            margin-bottom: 10px;
        }
        
        .popup-info {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .popup-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .status-endangered {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .status-vulnerable {
            background: #ffe0b2;
            color: #ef6c00;
        }
        
        .status-least-concern {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .status-near-threatened {
            background: #fff9c4;
            color: #f57f17;
        }
        .status-critically-endangered {
            background: #ffcccb;
            color: #b71c1c;
        }

        .status-extinct-wild {
            background: #d7ccc8;
            color: #4e342e;
        }

        .status-data-deficient {
            background: #eceff1;
            color: #455a64;
        }

        .status-not-evaluated {
            background: #f5f5f5;
            color: #616161;
        }
        
        /* Legend */
        .map-legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-dark);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .icon-fauna {
            background: #ff6b6b;
        }
        
        .icon-flora {
            background: #51cf66;
        }
        
        /* Statistics */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            #map {
                height: 400px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Styles for species list section */
        .species-list-section {
            padding: 30px 0;
            background: #fafafa;
            border-top: 1px solid #eee;
            display: none;
        }

        .species-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .species-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .species-card .species-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: #eee;
        }

        .species-card .species-info {
            padding: 10px 12px;
        }

        .species-card .species-name {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .species-card .species-scientific {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        /* Tab styles */
        .tabs { display:flex; gap:8px; margin-bottom:12px; }
        .tab-btn { padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: transparent }

        /* Marker highlight when focusing from list */
        .marker-highlight { transform: scale(1.2); box-shadow: 0 8px 18px rgba(0,0,0,0.35); transition: transform 0.18s ease; }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">üåø</span>
            <h1>Flora & Fauna Indonesia</h1>
        </div>
        <nav>
            <ul>
                <li><a href="#map-section" class="active">Peta Interaktif</a></li>
                <li><a href="#species-section">Daftar Spesies</a></li>
                <li><a href="#quiz-section">Kuis Edukasi</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <section id="map-section">
            <h2 class="section-title">Peta Persebaran Flora & Fauna</h2>
            <div class="tabs" role="tablist" aria-label="Tampilan">
                <button class="tab-btn active" data-target="#map-section" role="tab" aria-selected="true">Peta</button>
                <button class="tab-btn" data-target="#species-section" role="tab" aria-selected="false">Daftar Spesies</button>
            </div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="categoryFilter">Kategori</label>
                    <select id="categoryFilter">
                        <option value="all">Semua</option>
                        <option value="fauna">Fauna</option>
                        <option value="flora">Flora</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="statusFilter">Status Konservasi</label>
                    <select id="statusFilter">
                        <option value="all">Semua Status</option>
                        <option value="critically-endangered">Kritis (CR)</option>
                        <option value="endangered">Terancam Punah (EN)</option>
                        <option value="vulnerable">Rentan (VU)</option>
                        <option value="near-threatened">Hampir Terancam (NT)</option>
                        <option value="least-concern">Berisiko Rendah (LC)</option>
                        <option value="extinct-wild">Punah di Alam Liar (EW)</option>
                        <option value="data-deficient">Informasi Kurang (DD)</option>
                        <option value="not-evaluated">Belum Dievaluasi / Lainnya (NE)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="provinceFilter">Provinsi</label>
                    <select id="provinceFilter">
                        <option value="all">Semua Provinsi</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="searchInput">Cari Spesies</label>
                    <div class="search-input">
                        <input list="speciesList" id="searchInput" type="search" placeholder="Masukkan nama spesies atau provinsi...">
                        <button id="searchBtn" title="Cari">Cari</button>
                    </div>
                    <datalist id="speciesList"></datalist>
                </div>
            </div>
        </div>
        
        <!-- Map -->
        <div class="map-wrapper">
            <div id="map"></div>
        </div>
        
        <!-- Legend -->
        <div class="map-legend">
            <div class="legend-title">Keterangan Kategori</div>
            <div class="legend-item">
                <div style="font-size: 24px; text-align: center; width: 30px;">ü¶Å</div>
                <span>Fauna (Hewan)</span>
            </div>
            <div class="legend-item">
                <div style="font-size: 24px; text-align: center; width: 30px;">üåø</div>
                <span>Flora (Tumbuhan)</span>
            </div>
            <div class="legend-title" style="margin-top: 15px;">Status Konservasi</div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #d32f2f;"></div>
                <span>Terancam Punah (Endangered)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #f57c00;"></div>
                <span>Rentan (Vulnerable)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #fbc02d;"></div>
                <span>Hampir Terancam (Near-Threatened)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #388e3c;"></div>
                <span>Berisiko Rendah (Least-Concern)</span>
            </div>

            <div class="legend-item">
                <div class="legend-icon" style="background: #b71c1c;"></div>
                <span>Kritis (Critically Endangered - CR)</span>
            </div>

            <div class="legend-item">
                <div class="legend-icon" style="background: #6d4c41;"></div>
                <span>Punah di Alam Liar (Extinct in Wild - EW)</span>
            </div>

            <div class="legend-item">
                <div class="legend-icon" style="background: #607d8b;"></div>
                <span>Informasi Kurang (Data Deficient - DD)</span>
            </div>

            <div class="legend-item">
                <div class="legend-icon" style="background: #9e9e9e;"></div>
                <span>Belum Dievaluasi / Lainnya (NE)</span>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalSpecies">0</div>
                <div class="stat-label">Total Spesies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFauna">0</div>
                <div class="stat-label">Fauna</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFlora">0</div>
                <div class="stat-label">Flora</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEndangered">0</div>
                <div class="stat-label">Terancam Punah</div>
            </div>
        </div>
        </section>
    </div>

    <!-- Species list section -->
    <section id="species-section" class="species-list-section">
        <div class="container">
            <h2 class="section-title">Daftar Spesies</h2>
            <p>Daftar lengkap flora & fauna. Gunakan filter pada Peta untuk mempersempit daftar.</p>
            <div id="species-list" class="species-list-grid" aria-live="polite"></div>
        </div>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Data spesies flora dan fauna Indonesia dari database
        let speciesData = [];

        // Fetch data dari API
        async function fetchSpeciesData() {
            try {
                const response = await fetch('manpro_filter/api_species.php');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // Transform data untuk kompatibilitas dengan kode yang ada
                speciesData = data.map(item => ({
                    id: item.id,
                    name: item.name,
                    scientificName: item.scientificName,
                    category: item.category,
                    description: item.description,
                    conservationStatus: item.conservationStatus.toLowerCase().replace(/\s+/g, '-'),
                    originalStatus: item.originalStatus || '',
                    habitat: item.habitat,
                    province: item.province,
                    image: item.image,
                    wikiLink: item.wikiLink,
                    location: {
                        lat: parseFloat(item.latitude),
                        lng: parseFloat(item.longitude)
                    }
                }));

                // Debug: tampilkan daftar status yang diterima dari API
                const uniqueStatuses = [...new Set(data.map(i => i.conservationStatus))];
                const uniqueOriginals = [...new Set(data.map(i => i.originalStatus))];
                console.info('API conservationStatus (normalized):', uniqueStatuses);
                console.info('API originalStatus (raw DB):', uniqueOriginals);

                // Inisialisasi peta setelah data dimuat
                initMap();

                // Render species list section (if present) so "Daftar Spesies" anchor has content
                if (typeof renderSpeciesList === 'function') {
                    renderSpeciesList(speciesData);
                }

            } catch (error) {
                console.error('Error fetching species data:', error);
                // Fallback ke data dummy jika API gagal
                speciesData = [
                    {
                        id: 1,
                        name: "Orangutan Sumatera",
                        scientificName: "Pongo abelii",
                        category: "fauna",
                        description: "Orangutan Sumatera adalah kera besar endemik Sumatera.",
                        conservationStatus: "endangered",
                        habitat: "Hutan hujan tropis",
                        province: "Sumatera Utara",
                        image: "https://images.unsplash.com/photo-1540573133985-87b6da6d54a9?w=400",
                        location: { lat: 3.5952, lng: 98.6722 }
                    }
                ];
                initMap();
            }
        }

        // Render daftar spesies ke section #species-list (dipakai oleh halaman utama)
        function renderSpeciesList(data) {
            const container = document.getElementById('species-list');
            if (!container) return;
            container.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'species-list-grid';

            data.forEach(species => {
                const card = document.createElement('div');
                card.className = 'species-card';

                const img = document.createElement('img');
                img.className = 'species-image';
                img.src = species.image || 'https://via.placeholder.com/400x300?text=No+Image';
                img.alt = species.name;

                const info = document.createElement('div');
                info.className = 'species-info';

                const title = document.createElement('div');
                title.className = 'species-name';
                title.textContent = species.name;

                const sci = document.createElement('div');
                sci.className = 'species-scientific';
                sci.textContent = species.scientificName || '';

                const meta = document.createElement('div');
                meta.style.fontSize = '0.85rem';
                meta.style.color = '#444';
                meta.innerHTML = `<strong>Kategori:</strong> ${species.category === 'fauna' ? 'Fauna' : 'Flora'} ¬∑ <strong>Provinsi:</strong> ${species.province || '-'}`;

                const btns = document.createElement('div');
                btns.style.marginTop = '8px';

                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'Tampilkan di Peta';
                viewBtn.style.background = 'var(--primary-color)';
                viewBtn.style.color = 'white';
                viewBtn.style.border = 'none';
                viewBtn.style.padding = '6px 8px';
                viewBtn.style.borderRadius = '6px';
                viewBtn.style.cursor = 'pointer';

                viewBtn.addEventListener('click', () => {
                    // Switch to map tab, center and open popup for this species
                    switchTab('map');
                    setTimeout(() => {
                        try {
                            if (species.location && map) {
                                map.setView([species.location.lat, species.location.lng], 12);
                            }
                            const marker = speciesIdToMarker[species.id];
                            if (marker) {
                                marker.openPopup();
                                const el = (typeof marker.getElement === 'function') ? marker.getElement() : marker._icon;
                                if (el) {
                                    el.classList.add('marker-highlight');
                                    setTimeout(() => el.classList.remove('marker-highlight'), 1200);
                                }
                            }
                        } catch (e) { console.warn('Could not focus marker', e); }
                    }, 300);
                });

                btns.appendChild(viewBtn);

                info.appendChild(title);
                info.appendChild(sci);
                info.appendChild(meta);
                info.appendChild(btns);

                card.appendChild(img);
                card.appendChild(info);

                grid.appendChild(card);
            });

            container.appendChild(grid);
        }

        // Helper: switch visible tab (map or species list)
        function switchTab(target) {
            // target: 'map' or 'species' or selector like '#map-section'
            const t = (target||'').toString();
            const mapSection = document.getElementById('map-section');
            const speciesSection = document.getElementById('species-section');

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const btnTarget = btn.getAttribute('data-target');
                const isActive = (btnTarget === '#map-section' && (t==='map' || t==='#map-section')) || (btnTarget === '#species-section' && (t==='species' || t==='#species-section'));
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });

            if (t==='species' || t==='#species-section') {
                if (speciesSection) speciesSection.style.display = 'block';
                if (mapSection) mapSection.style.display = 'none';
                // focus first item for accessibility
                const first = document.querySelector('#species-list .species-card');
                if (first) first.focus();
            } else {
                if (speciesSection) speciesSection.style.display = 'none';
                if (mapSection) mapSection.style.display = 'block';
            }
        }

        // Inisialisasi peta
        let map;
        let markers = [];
        let markerLayer;
        let speciesIdToMarker = {};

        function initMap() {
            // Buat peta dengan center di Indonesia
            map = L.map('map').setView([-2.5489, 118.0149], 5);

            // Tambahkan tile layer OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);

            // Use MarkerClusterGroup for clustering markers
            markerLayer = L.markerClusterGroup({ chunkedLoading: true });
            markerLayer.addTo(map);

            // Render semua marker
            renderMarkers(speciesData);

            // Update statistik
            updateStatistics(speciesData);

            // Populate province filter and search datalist
            populateProvinceFilter();
            populateSearchDatalist();
        }

        function getMarkerIcon(category, status) {
            // Choose icon based on category
            const icons = {
                fauna: 'ü¶Å', // fauna (lion)
                flora: 'üåø'  // flora (leaf)
            };
            
            const icon = icons[category] || 'üìç';
            
            // Color based on conservation status
            const statusColors = {
                'critically-endangered': '#b71c1c',
                'endangered': '#d32f2f',
                'vulnerable': '#f57c00',
                'near-threatened': '#fbc02d',
                'least-concern': '#388e3c',
                'extinct-wild': '#6d4c41',
                'data-deficient': '#607d8b',
                'not-evaluated': '#9e9e9e'
            };
            
            const bgColor = statusColors[status] || '#757575';
            
            return L.divIcon({
                html: `<div style="
                    background: linear-gradient(135deg, ${bgColor} 0%, ${bgColor}dd 100%);
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.4);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 20px;
                    cursor: pointer;
                    transition: transform 0.2s ease;
                " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                    ${icon}
                </div>`,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'critically-endangered': 'Kritis (Sangat Terancam Punah)',
                'endangered': 'Terancam Punah',
                'vulnerable': 'Rentan',
                'near-threatened': 'Hampir Terancam',
                'least-concern': 'Berisiko Rendah',
                'extinct-wild': 'Punah di Liar',
                'data-deficient': 'Informasi Kurang',
                'not-evaluated': 'Belum Dievaluasi'
            };
            return statusMap[status] || 'Tidak Diketahui';
        }

        function getStatusClass(status) {
            return `status-${status}`;
        }

        function createPopupContent(species) {
            return `
                <div class="custom-popup">
                    <img src="${species.image}" alt="${species.name}" class="popup-image">
                    <div class="popup-title">${species.name}</div>
                    <div class="popup-scientific">${species.scientificName}</div>
                    <div class="popup-info"><strong>Kategori:</strong> ${species.category === 'fauna' ? 'Fauna' : 'Flora'}</div>
                    <div class="popup-info"><strong>Provinsi:</strong> ${species.province}</div>
                    <div class="popup-info"><strong>Koordinat:</strong> ${species.location && species.location.lat ? species.location.lat.toFixed(6) : '-'}, ${species.location && species.location.lng ? species.location.lng.toFixed(6) : '-'}</div>
                    <div class="popup-info"><strong>Habitat:</strong> ${species.habitat}</div>
                    <span class="popup-status ${getStatusClass(species.conservationStatus)}">
                        ${getStatusText(species.conservationStatus)}
                    </span>
                    <p style="margin-top: 10px; font-size: 0.9rem;">${species.description}</p>
                    ${species.wikiLink ? `<a href="${species.wikiLink}" target="_blank" style="display: block; margin-top: 10px; color: #2e7d32; text-decoration: none; font-weight: bold;">üìñ Baca Selengkapnya di Wikipedia</a>` : ''}
                </div>
            `;
        }

        function renderMarkers(data) {
            // Hapus semua marker yang ada
            markerLayer.clearLayers();
            markers = [];
            speciesIdToMarker = {};

            // Tambahkan marker baru (di-cluster oleh markerCluster plugin)
            data.forEach(species => {
                const marker = L.marker(
                    [species.location.lat, species.location.lng],
                    { icon: getMarkerIcon(species.category, species.conservationStatus) }
                )
                .bindPopup(createPopupContent(species), {
                    maxWidth: 300,
                    className: 'custom-popup-container'
                });

                markerLayer.addLayer(marker);
                markers.push(marker);
                speciesIdToMarker[species.id] = marker;
            });
        }

        // Populate search datalist with species names and provinces
        function populateSearchDatalist() {
            const datalist = document.getElementById('speciesList');
            datalist.innerHTML = '';

            const names = new Set();
            speciesData.forEach(s => {
                names.add(s.name);
                names.add(s.province);
            });

            Array.from(names).sort().forEach(n => {
                const option = document.createElement('option');
                option.value = n;
                datalist.appendChild(option);
            });
        }

        // Search function: find species by name or province. If multiple matches, fit bounds; if single, zoom to marker and open popup.
        function searchSpecies(query) {
            if (!query) return;
            const q = query.trim().toLowerCase();
            const matches = speciesData.filter(s => s.name.toLowerCase().includes(q) || s.province.toLowerCase().includes(q));

            if (matches.length === 0) {
                alert('Spesies atau provinsi tidak ditemukan.');
                return;
            }

            if (matches.length === 1) {
                const s = matches[0];
                const marker = speciesIdToMarker[s.id];
                if (marker) {
                    map.setView([s.location.lat, s.location.lng], 12);
                    // open popup after map animates
                    setTimeout(() => marker.openPopup(), 300);
                }
                return;
            }

            // Multiple matches: fit bounds of their markers
            const latlngs = matches.map(s => [s.location.lat, s.location.lng]);
            const bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds.pad(0.25));
        }

        function filterSpecies() {
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            const province = document.getElementById('provinceFilter').value;
            
            const filtered = speciesData.filter(species => {
                const matchCategory = category === 'all' || species.category === category;
                const matchStatus = status === 'all' || species.conservationStatus === status;
                const matchProvince = province === 'all' || species.province === province;
                
                return matchCategory && matchStatus && matchProvince;
            });
            
            renderMarkers(filtered);
            updateStatistics(filtered);
        }

        function updateStatistics(data) {
            const totalSpecies = data.length;
            const totalFauna = data.filter(s => s.category === 'fauna').length;
            const totalFlora = data.filter(s => s.category === 'flora').length;
            const totalEndangered = data.filter(s => s.conservationStatus === 'endangered').length;
            
            document.getElementById('totalSpecies').textContent = totalSpecies;
            document.getElementById('totalFauna').textContent = totalFauna;
            document.getElementById('totalFlora').textContent = totalFlora;
            document.getElementById('totalEndangered').textContent = totalEndangered;
        }

        function populateProvinceFilter() {
            const provinces = [...new Set(speciesData.map(s => s.province))].sort();
            const select = document.getElementById('provinceFilter');
            
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                select.appendChild(option);
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data dari API terlebih dahulu
            fetchSpeciesData();

            // Tab buttons (map / list)
            document.querySelectorAll('.tab-btn').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const target = btn.getAttribute('data-target');
                    if (target === '#species-section') switchTab('species');
                    else switchTab('map');
                    // sync nav active state
                    document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));
                    const navLink = document.querySelector(`nav a[href="${target}"]`);
                    if (navLink) navLink.classList.add('active');
                });
            });

            // Ensure initial tab view is map
            switchTab('map');
            
            document.getElementById('categoryFilter').addEventListener('change', filterSpecies);
            document.getElementById('statusFilter').addEventListener('change', filterSpecies);
            document.getElementById('provinceFilter').addEventListener('change', filterSpecies);
            
            // Search listeners
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) searchBtn.addEventListener('click', () => searchSpecies(searchInput.value));
            if (searchInput) searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchSpecies(searchInput.value);
                }
            });
            
            // Smooth scroll untuk navigasi / tab switch
            document.querySelectorAll('nav a').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    const href = this.getAttribute('href') || '';
                    // Only intercept internal anchors (hash links)
                    if (!href.startsWith('#')) return; 
                    e.preventDefault();

                    // Hapus kelas active dari semua link
                    document.querySelectorAll('nav a').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Tambahkan kelas active ke link yang diklik
                    this.classList.add('active');

                    // If the nav targets our sections, switch tabs instead of scrolling
                    if (href === '#species-section') {
                        switchTab('species');
                        return;
                    }
                    if (href === '#map-section') {
                        switchTab('map');
                        return;
                    }

                    const targetId = href;
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
